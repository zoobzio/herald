---
title: API Reference
description: Complete herald API documentation
author: zoobzio
published: 2025-12-11
updated: 2025-12-11
tags:
  - Reference
  - API
---

# API Reference

Complete reference for herald's public API.

## Core Types

### Provider

```go
type Provider interface {
    Publish(ctx context.Context, data []byte, metadata Metadata) error
    Subscribe(ctx context.Context) <-chan Result[Message]
    Close() error
}
```

The interface all broker providers implement.

### Message

```go
type Message struct {
    Data     []byte
    Metadata Metadata
    Ack      func() error
    Nack     func() error
}
```

Represents a message received from a broker.

| Field | Description |
|-------|-------------|
| `Data` | Raw message payload |
| `Metadata` | Message headers/attributes |
| `Ack` | Acknowledge successful processing |
| `Nack` | Reject for redelivery |

### Metadata

```go
type Metadata map[string]string
```

Key-value pairs for message headers.

### Result[T]

```go
type Result[T any] struct {
    // unexported fields
}

func NewSuccess[T any](value T) Result[T]
func NewError[T any](err error) Result[T]

func (r Result[T]) IsSuccess() bool
func (r Result[T]) IsError() bool
func (r Result[T]) Value() T
func (r Result[T]) Error() error
```

Discriminated union for either a value or error.

### Error

```go
type Error struct {
    Operation string // "publish", "subscribe", "unmarshal", "ack", "nack"
    Signal    string // Signal name
    Err       string // Error message (string for JSON serialization)
    Nack      bool   // Whether message was nack'd
    Raw       []byte // Raw payload (for unmarshal errors)
}
```

Error information emitted on `ErrorSignal`. Note that `Err` is a string (not `error`) to support JSON serialization.

## Publisher

### NewPublisher

```go
func NewPublisher[T any](
    provider Provider,
    signal capitan.Signal,
    key capitan.Key[T],
    opts []Option[T],
    pubOpts ...PublisherOption[T],
) *Publisher[T]
```

Creates a new publisher.

| Parameter | Description |
|-----------|-------------|
| `provider` | Broker provider |
| `signal` | Capitan signal to observe |
| `key` | Typed key for extracting values |
| `opts` | Pipeline options (retry, timeout, etc.) |
| `pubOpts` | Publisher-specific options |

### Publisher Methods

```go
func (p *Publisher[T]) Start()
func (p *Publisher[T]) Close() error
```

| Method | Description |
|--------|-------------|
| `Start` | Begin observing the signal |
| `Close` | Stop observing and wait for in-flight publishes |

### Publisher Options

```go
func WithPublisherCodec[T any](codec Codec) PublisherOption[T]
func WithPublisherCapitan[T any](c *capitan.Capitan) PublisherOption[T]
```

| Option | Description |
|--------|-------------|
| `WithPublisherCodec` | Use custom serialization codec |
| `WithPublisherCapitan` | Use custom capitan instance |

## Subscriber

### NewSubscriber

```go
func NewSubscriber[T any](
    provider Provider,
    signal capitan.Signal,
    key capitan.Key[T],
    opts []Option[T],
    subOpts ...SubscriberOption[T],
) *Subscriber[T]
```

Creates a new subscriber.

| Parameter | Description |
|-----------|-------------|
| `provider` | Broker provider |
| `signal` | Capitan signal to emit to |
| `key` | Typed key for creating fields |
| `opts` | Pipeline options |
| `subOpts` | Subscriber-specific options |

### Subscriber Methods

```go
func (s *Subscriber[T]) Start(ctx context.Context)
func (s *Subscriber[T]) Close() error
```

| Method | Description |
|--------|-------------|
| `Start` | Begin consuming messages; the context controls subscriber lifetime |
| `Close` | Stop consuming and wait for goroutine to exit |

### Subscriber Options

```go
func WithSubscriberCodec[T any](codec Codec) SubscriberOption[T]
func WithSubscriberCapitan[T any](c *capitan.Capitan) SubscriberOption[T]
```

| Option | Description |
|--------|-------------|
| `WithSubscriberCodec` | Use custom deserialization codec |
| `WithSubscriberCapitan` | Use custom capitan instance |

## Codec

### Codec Interface

```go
type Codec interface {
    Marshal(v any) ([]byte, error)
    Unmarshal(data []byte, v any) error
    ContentType() string
}
```

### JSONCodec

```go
type JSONCodec struct{}
```

Default codec using `encoding/json`.

## Pipeline Options

```go
type Option[T any] func(*pipz.Pipeline[PublishFunc[T]])
```

### WithRetry

```go
func WithRetry[T any](maxAttempts int) Option[T]
```

Retry failed operations up to `maxAttempts` times.

### WithBackoff

```go
func WithBackoff[T any](maxAttempts int, baseDelay time.Duration) Option[T]
```

Retry with exponential backoff. Delays double each attempt.

### WithTimeout

```go
func WithTimeout[T any](timeout time.Duration) Option[T]
```

Cancel operations exceeding the timeout.

### WithCircuitBreaker

```go
func WithCircuitBreaker[T any](maxFailures int, recoveryTime time.Duration) Option[T]
```

Open circuit after `maxFailures` consecutive failures. Attempt recovery after `recoveryTime`.

### WithRateLimit

```go
func WithRateLimit[T any](rate float64, burst int) Option[T]
```

Limit operations to `rate` per second with `burst` capacity.

### WithErrorHandler

```go
func WithErrorHandler[T any](handler pipz.Chainable[*pipz.Error[T]]) Option[T]
```

Custom error handling via a pipz chainable. The handler receives rich error context including the input data, timestamp, and path through the pipeline. The handler observes errors without modifying the error flow.

```go
// Example: Log errors with context
errorLogger := pipz.Effect("log-error", func(ctx context.Context, err *pipz.Error[Order]) error {
    log.Printf("failed at %v: %v (input: %+v)", err.Path, err.Err, err.InputData)
    return nil
})

pub := herald.NewPublisher(provider, signal, key, []herald.Option[Order]{
    herald.WithErrorHandler[Order](errorLogger),
})
```

### WithPipeline

```go
func WithPipeline[T any](pipeline *pipz.Pipeline[PublishFunc[T]]) Option[T]
```

Use a fully custom pipeline.

## Context Functions

### ContextWithMetadata

```go
func ContextWithMetadata(ctx context.Context, meta Metadata) context.Context
```

Attach metadata to context for propagation.

### MetadataFromContext

```go
func MetadataFromContext(ctx context.Context) Metadata
```

Extract metadata from context. Returns empty map if none present.

## Error Signals

### ErrorSignal

```go
var ErrorSignal = capitan.NewSignal("herald.error", "Herald operational error")
```

Signal for all herald errors.

### ErrorKey

```go
var ErrorKey = capitan.NewKey[Error]("error", "herald.Error")
```

Key for extracting error details.

## Sentinel Errors

```go
var (
    ErrNoWriter = errors.New("herald: no writer configured")
    ErrNoReader = errors.New("herald: no reader configured")
)
```

| Error | Description |
|-------|-------------|
| `ErrNoWriter` | Provider has no write capability |
| `ErrNoReader` | Provider has no read capability |
